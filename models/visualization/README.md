# Visualization Module

Generates animated GIFs from dispatch simulation logs.

## Purpose

Creates animated visualizations showing courier-order assignments across all dispatch cycles. Supports three visualization modes:
- **Baseline**: Assignments made by simulation algorithm
- **Actual**: Historical assignments made by Meituan system
- **Comparison**: Side-by-side view of baseline vs actual

## Dependencies

```bash
imageio>=2.31.0
matplotlib>=3.7.0
polars>=0.19.0
```

## Data Requirements

Assignment log CSV must contain courier location columns:
- `baseline_courier_lat`, `baseline_courier_lng`: Simulation courier locations
- `actual_courier_lat`, `actual_courier_lng`: Historical courier locations

These columns are automatically generated by enhanced SimulationLogger (simulator/logger.py).

## Modules

### frame_generator.py

**Function: `generate_dispatch_frame(dispatch_time, assignments_df, mode, save_path)`**

Generates single frame for one dispatch cycle.

Parameters:
- `dispatch_time`: Unix timestamp
- `assignments_df`: Polars DataFrame (filtered to single dispatch moment)
- `mode`: 'baseline' or 'actual'
- `save_path`: PNG output path (optional)

Returns:
- matplotlib figure if save_path is None, otherwise None

**Function: `generate_comparison_frame(dispatch_time, assignments_df, save_path)`**

Generates side-by-side comparison frame (baseline left, actual right).

Parameters:
- `dispatch_time`: Unix timestamp
- `assignments_df`: Polars DataFrame (filtered to single dispatch moment)
- `save_path`: PNG output path (optional)

Returns:
- matplotlib figure if save_path is None, otherwise None

### animator.py

**Function: `create_single_gif(assignment_log_path, mode, output_path, duration)`**

Creates GIF for single mode (baseline or actual).

Parameters:
- `assignment_log_path`: Path to assignment log CSV
- `mode`: 'baseline' or 'actual'
- `output_path`: GIF output path
- `duration`: Seconds per frame (default 1.0)

Returns:
- output_path on success

**Function: `create_comparison_gif(assignment_log_path, output_path, duration)`**

Creates side-by-side comparison GIF.

Parameters:
- `assignment_log_path`: Path to assignment log CSV
- `output_path`: GIF output path
- `duration`: Seconds per frame (default 1.0)

Returns:
- output_path on success

**Function: `create_all_gifs(assignment_log_path, output_dir, duration)`**

Creates all three GIF types (baseline, actual, comparison).

Parameters:
- `assignment_log_path`: Path to assignment log CSV
- `output_dir`: Directory for output GIFs
- `duration`: Seconds per frame (default 1.0)

Returns:
- Dictionary mapping GIF type to output path

## Usage

### Command Line

```bash
# From models/visualization/ directory
python create_gifs.py --assignment-log ../logs/assignment_log.csv --mode comparison

# All GIF types
python create_gifs.py --assignment-log ../logs/assignment_log.csv --mode all

# Custom duration
python create_gifs.py --assignment-log ../logs/assignment_log.csv --mode baseline --duration 1.5
```

### Python API

```python
from visualization.animator import create_comparison_gif

create_comparison_gif(
    assignment_log_path='logs/01_tier1_bipartite_distance_to_pickup_assignment_log_20251027.csv',
    output_path='gifs/comparison.gif',
    duration=1.2
)
```

## Output Format

GIF files loop indefinitely (loop=0). Each frame shows:

**Baseline Mode:**
- Red triangles: Available couriers (simulation)
- Blue circles: Waiting orders
- Gray lines: Assignment connections

**Actual Mode:**
- Gray triangles: All historical couriers
- Blue circles: Waiting orders
- Purple lines: Assignment connections

**Comparison Mode:**
- Left subplot: Baseline
- Right subplot: Actual

## Frame Generation

1. Reads assignment log CSV into Polars DataFrame
2. Extracts unique dispatch times (sorted)
3. For each dispatch time:
   - Filters DataFrame to that moment
   - Generates PNG frame
   - Saves to temporary directory
4. Stitches frames into GIF using imageio
5. Cleans up temporary frame files

## Performance

24 dispatch cycles generate 24 frames. Typical execution time:
- Single GIF: 10-15 seconds
- All GIFs (3 types): 30-45 seconds

Output file sizes:
- Single mode GIF: 5-8 MB
- Comparison GIF: 12-15 MB
